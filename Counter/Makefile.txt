# ============================================================
# SETTINGS
# ============================================================
TOP       = counter_top
TESTS     = TEST1 TEST2           # <--- Add/remove testcases here

UCDB_DIR  = ucdb_runs
MERGED    = merged.ucdb

FUNC_DIR  = cov_func_html
CODE_DIR  = cov_code_html
ALL_DIR   = cov_html

FUNC_INDEX = $(FUNC_DIR)/index.html
CODE_INDEX = $(CODE_DIR)/index.html
ALL_INDEX  = $(ALL_DIR)/index.html


# ============================================================
# HELP
# ============================================================
help:
	@echo ""
	@echo "Questa Regression + Coverage"
	@echo "----------------------------"
	@echo "make compile         - Compile RTL + TB"
	@echo "make run TEST=T      - Run simulation for one testcase"
	@echo "make regress         - Run all tests + merge UCDB"
	@echo "make report          - Generate functional + code + combined reports"
	@echo "make view_func       - View functional coverage report"
	@echo "make view_code       - View code coverage report"
	@echo "make view_combo      - View combined coverage report"
	@echo "make clean           - Clean all output"
	@echo ""


# ============================================================
# COMPILE
# ============================================================
compile:
	vlib work
	vlog +acc +cover=bcesft test.sv


# ============================================================
# RUN ONE TESTCASE
# Generates:  ucdb_runs/TEST1.ucdb, ucdb_runs/TEST2.ucdb, etc.
# ============================================================
run:
	@if [ -z "$$TEST" ]; then \
		echo "ERROR: Use  make run TEST=TEST1"; exit 1; \
	fi
	mkdir -p $(UCDB_DIR)
	vsim -coverage -c work.$(TOP) \
		-do "run -all; coverage save -onexit $(UCDB_DIR)/$$TEST.ucdb; quit -f" \
		-l sim_$$TEST.log +$$TEST


# ============================================================
# FULL REGRESSION FOR ALL TESTS
# ============================================================
regress:
	@echo "Running regression for tests: $(TESTS)"
	@for t in $(TESTS); do \
		echo ""; \
		echo "=============================="; \
		echo " Running TEST = $$t"; \
		echo "=============================="; \
		$(MAKE) run TEST=$$t || exit 1; \
	done

	@echo "Merging UCDB files..."
	vcover merge $(MERGED) $(UCDB_DIR)/*.ucdb


# ============================================================
# FUNCTIONAL COVERAGE REPORT
# Shows bin hits/misses individually
# ============================================================
func_report:
	vcover report -html -cvg -details -nocompactcrossbins -directive -verbose \
		-output $(FUNC_DIR) $(MERGED)


# ============================================================
# CODE COVERAGE REPORT
# ============================================================
code_report:
	vcover report -html -codeAll -details -verbose \
		-output $(CODE_DIR) $(MERGED)


# ============================================================
# COMBINED COVERAGE REPORT
# ============================================================
combo_report:
	vcover report -html -codeAll -cvg -assert -details -verbose \
		-output $(ALL_DIR) $(MERGED)


# ============================================================
# GENERATE ALL REPORTS
# ============================================================
report: func_report code_report combo_report


# ============================================================
# OPEN REPORTS
# ============================================================
view_func:
	@if [ -f $(FUNC_INDEX) ]; then xdg-open $(FUNC_INDEX); \
	else echo "Run: make func_report"; fi

view_code:
	@if [ -f $(CODE_INDEX) ]; then xdg-open $(CODE_INDEX); \
	else echo "Run: make code_report"; fi

view_combo:
	@if [ -f $(ALL_INDEX) ]; then xdg-open $(ALL_INDEX); \
	else echo "Run: make combo_report"; fi


# ============================================================
# CLEAN
# ============================================================
clean:
	rm -rf work transcript* *.log vsim.wlf \
		$(UCDB_DIR) $(MERGED) \
		$(FUNC_DIR) $(CODE_DIR) $(ALL_DIR)
